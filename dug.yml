port_forward() {
  local dev_pod=$1
  local base_port=$2
  local remote_port=$3
  local name=$4
  local local_port=$(get_available_port $base_port)
  local max_retries=5

  monitor_port_forward() {
    local retries=0
    while true; do
      kubectl port-forward pod/$dev_pod $local_port:$remote_port -n "$NAMESPACE" >/dev/null 2>&1 &
      local pf_pid=$!
      wait $pf_pid
      echo "[$(date)] Port forward for $name died, restarting..." >&2
      ((retries++))
      if [[ $retries -ge $max_retries ]]; then
        echo "[$(date)] Port forward for $name failed too many times, giving up." >&2
        break
      fi
      sleep 2
    done
  }

  monitor_port_forward &
  local monitor_pid=$!

  # Save the monitor PID so you can clean up if needed
  PIDS+=($monitor_pid)
  PORTS+=($local_port)

  echo $local_port
}
